generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  TEACHER
  PARENT
  ADMIN
  SUPER_ADMIN
}

model School {
  id        String   @id @default(cuid())
  name      String
  subdomain String   @unique
  logoUrl   String?  @map("logo_url")
  primaryColor String? @map("primary_color")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users    User[]
  students Student[]
  forms    PermissionForm[]
  invites  Invite[]

  @@map("schools")
}

enum FormStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum SubmissionStatus {
  PENDING
  SIGNED
  DECLINED
}

enum EventType {
  FIELD_TRIP
  SPORTS
  ACTIVITY
  OTHER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role
  schoolId  String?  @map("school_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  school           School?             @relation(fields: [schoolId], references: [id])
  forms            PermissionForm[]    @relation("TeacherForms")
  parentStudents   ParentStudent[]
  formSubmissions  FormSubmission[]
  invitesSent      Invite[]            @relation("InviteCreator")
  auditLogs        AuditLog[]

  @@index([schoolId])
  @@map("users")
}

model Student {
  id        String   @id @default(cuid())
  name      String
  grade     String
  schoolId  String?  @map("school_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  school          School?          @relation(fields: [schoolId], references: [id])
  parents         ParentStudent[]
  formSubmissions FormSubmission[]

  @@index([schoolId])
  @@map("students")
}

model ParentStudent {
  parentId     String
  studentId    String
  relationship String

  parent  User    @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@id([parentId, studentId])
  @@map("parent_students")
}

model PermissionForm {
  id          String      @id @default(cuid())
  teacherId   String      @map("teacher_id")
  schoolId    String?     @map("school_id")
  title       String
  description String      @db.Text
  eventDate   DateTime    @map("event_date")
  eventType   EventType   @default(OTHER) @map("event_type")
  deadline    DateTime
  status      FormStatus  @default(DRAFT)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  school      School?          @relation(fields: [schoolId], references: [id])
  teacher     User             @relation("TeacherForms", fields: [teacherId], references: [id], onDelete: Cascade)
  fields      FormField[]
  submissions FormSubmission[]

  @@index([teacherId, status])
  @@index([schoolId])
  @@map("permission_forms")
}

model FormField {
  id        String  @id @default(cuid())
  formId    String  @map("form_id")
  fieldType String  @map("field_type")
  label     String
  required  Boolean @default(false)
  order     Int

  // Relations
  form      PermissionForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  responses FieldResponse[]

  @@index([formId])
  @@map("form_fields")
}

model FormSubmission {
  id            String           @id @default(cuid())
  formId        String           @map("form_id")
  parentId      String           @map("parent_id")
  studentId     String           @map("student_id")
  signatureData String           @map("signature_data") @db.Text
  signedAt      DateTime?        @map("signed_at")
  ipAddress     String?          @map("ip_address")
  status        SubmissionStatus @default(PENDING)

  // Relations
  form      PermissionForm  @relation(fields: [formId], references: [id], onDelete: Cascade)
  parent    User            @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student   Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  responses FieldResponse[]

  @@unique([formId, parentId, studentId])
  @@index([parentId])
  @@index([formId, status])
  @@map("form_submissions")
}

model FieldResponse {
  id           String @id @default(cuid())
  submissionId String @map("submission_id")
  fieldId      String @map("field_id")
  response     String @db.Text

  // Relations
  submission FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  field      FormField      @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("field_responses")
}

model Invite {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  role      Role     @default(ADMIN)
  schoolId  String?  @map("school_id")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  school    School?  @relation(fields: [schoolId], references: [id])
  creator   User     @relation("InviteCreator", fields: [createdBy], references: [id])

  @@index([token])
  @@index([email])
  @@map("invites")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  metadata  Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([email])
  @@map("password_reset_tokens")
}
